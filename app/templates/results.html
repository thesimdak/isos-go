{{ define "results.html" }}
<div x-data="{ 
  open: false, 
  selectedLabel: '{{ if .CategoryLabel }}{{ .CategoryLabel }}{{ else }}{{ (index .Categories 0).Label }}{{ end }}',
  selectedID: '{{ if .CategoryID }}{{ .CategoryID }}{{ else }}{{ (index .Categories 0).ID }}{{ end }}' 
}" @htmx:load.window.once="() => {
  if ('{{ .CategoryID }}' !== '') { 
    selectedID = '{{ .CategoryID }}'; // Use provided CategoryID if available
  }
  $refs.hiddenInput.value = selectedID;
  $refs.hiddenInput.dispatchEvent(new Event('change', { bubbles: true }))
}">
  {{ if ne .ResultView "true" }}
  <div class="text:xl md:text-2xl text-gray-600 border-b-1 border-gray-300 px-2 py-2">
    {{ .Name }}
  </div>
  {{ end }}
  <div class="relative w-64">
    <button @click="open = !open"
      class="text:xl md:text-2xl text-gray-600 px-2 py-2 bg-white focus:outline-none cursor-pointer">
      <span x-text="selectedLabel"></span> â–¼
    </button>

    <div x-show="open" @click.away="open = false"
      class="absolute w-full bg-white shadow-md mt-1 max-h-40 overflow-y-auto z-10">
      {{ range .Categories }}
      <div @click="selectedLabel = '{{ .Label }}'; selectedID = '{{ .ID }}'; open = false; 
        $refs.hiddenInput.value = selectedID; 
        $refs.hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
        
        // ðŸš€ NEW LOGIC START ðŸš€
        (function() {
          // 1. Get current URL query parameters
          const url = new URL(window.location);
          // 2. Set/Override the 'category' parameter
          url.searchParams.set('category', selectedID);
          // 3. Replace the URL state, preserving everything else
          history.replaceState(null, '', url.search);
        })();
        // ðŸš€ NEW LOGIC END ðŸš€
        "
        class="px-4 py-2 text-lg text-gray-600 cursor-pointer hover:bg-gray-100 border-b border-gray-300 last:border-b-0">
        {{ .Label }}
      </div>
      {{ end }}
    </div>

    <input type="hidden" id="category" name="category" x-ref="hiddenInput" hx-indicator="#spinner"
      :hx-get="`/result-table/{{ .CompetitionID }}`" hx-trigger="change" hx-target="#result-list">
  </div>
</div>

<div id="result-list">
  </div>
{{ end }}